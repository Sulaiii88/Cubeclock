<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Zeitwürfel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono&display=swap" rel="stylesheet" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>

  <style>
    :root{
      /* Default-UI-Farben – werden per Settings überschrieben */
      --c-hours:   #e71f1b;
      --c-mins:    #ff8c42;
      --c-secs:    #fff275;
      --c-year:    #4B0082;
      --c-month:   #2f4fba;
      --c-day:     #87c8fa;
      --c-cubeedge:#555555;
      --c-bg:      #000000;
    }

    /* ---------- Basis (unverändert) ---------- */
    body {
      margin: 0;
      background: var(--c-bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Space Mono', monospace;
      overflow: hidden;
      touch-action: none; /* wichtig für Touchsteuerung */
    }

    .scene {
      width: 63vmin;
      height: 63vmin;
      perspective: 1100px;
      margin-bottom: 90px;
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 1s ease;
      transform: rotateX(-30deg) rotateY(45deg);
    }

    .face {
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom right, #000, #111);
      color: #fff;
      font-size: calc(63vmin / 1.5);
      letter-spacing: -5px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid var(--c-cubeedge);
      backface-visibility: hidden;
    }

    .scene, .cube, .face {
      user-select: none;
      outline: none;
    }

    #hours   { color: var(--c-hours); }
    #minutes { color: var(--c-mins);  }
    #seconds { color: var(--c-secs);  }
    #year    { color: var(--c-year);  }
    #day     { color: var(--c-day);   }
    #month   {
      color: var(--c-month);
      font-size: calc(63vmin / 2);
      font-weight: bold;
    }

    .front  { transform: rotateY( 90deg) translateZ(31.5vmin) rotateY(180deg) rotateX(180deg); }
    .back   { transform: rotateY(180deg) translateZ(31.5vmin) rotateY(180deg) rotateX(180deg); }
    .right  { transform: rotateY(0deg) translateZ(31.5vmin); }
    .left   { transform: rotateY(-90deg) translateZ(31.5vmin); }
    .top    { transform: rotateX(90deg) translateZ(31.5vmin); }
    .bottom { transform: rotateX(-90deg) translateZ(31.5vmin); }

    button#toggleButton {
      position: absolute;
      bottom: 5vh;
      padding: 1px 100px;
      border: none;
      outline: none;
      box-shadow: none;
      border-radius: 10px;
      background-color: #444;
      cursor: pointer;
    }
    button#toggleButton:hover { background-color: #666; }
    button#toggleButton img { width: 30px; height: auto; display: block; }

    /* Laptop/Desktop – kleiner (unverändert) */
    @media (min-width: 601px) {
      .scene { width: 50vmin; height: 50vmin; }
      .face { font-size: calc(50vmin / 1.5); }
      #month { font-size: calc(50vmin / 2); }
      .front  { transform: rotateY( 90deg) translateZ(25vmin) rotateY(180deg) rotateX(180deg); }
      .back   { transform: rotateY(180deg) translateZ(25vmin) rotateY(180deg) rotateX(180deg); }
      .right  { transform: rotateY(0deg) translateZ(25vmin); }
      .left   { transform: rotateY(-90deg) translateZ(25vmin); }
      .top    { transform: rotateX(90deg) translateZ(25vmin); }
      .bottom { transform: rotateX(-90deg) translateZ(25vmin); }
    }

    /* PWA Handy skaliert (unverändert) */
    @media (display-mode: standalone) and (max-width: 600px) {
      .scene { transform: scale(3); transform-origin: center; }
    }

    /* ---------- Settings UI (Zahnrad + Panel) ---------- */
    .gear {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      display: grid;
      place-items: center;
      cursor: pointer;
      z-index: 50;
      backdrop-filter: blur(6px);
    }
    .gear img { width: 24px; height: 24px; filter: invert(100%); }

    .settings {
      position: fixed;
      top: 84px;       /* damit genau unter dem Zahnrad */
      left: 16px;
      width: min(92vw, 560px);
      max-height: calc(100vh - 120px);
      overflow: auto;
      background: rgba(30,30,31,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 22px 18px 18px;
      color: #e7e7e7;
      z-index: 60;
      backdrop-filter: blur(8px);
      display: none;
    }
    .settings.show { display: block; }

    .settings h2{
      margin: 4px 6px 16px;
      font-weight: 800;
      font-size: 28px;
      letter-spacing: 0.06em;
    }

    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px; padding: 10px 6px;
    }
    .row label{ font-size: 20px; letter-spacing: 0.06em; }
    .swatch{
      width: 84px; height: 40px; border-radius: 10px;
      border: 4px solid rgba(255,255,255,0.65);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.9);
      cursor: pointer;
    }

    .btn {
      width: 100%;
      margin: 10px 0;
      padding: 14px 16px;
      font-size: 18px;
      color: #e5e5e6;
      background: #3b3b3d;
      border: 1px solid #5a5a5c;
      border-radius: 14px;
    }

    /* ---------- Farbwähler (RGB) ---------- */
    .picker{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }
    .picker.show{ display:flex; }

    .picker-card{
      width: min(680px, 92vw);
      background: #262627;
      color: #f2f2f2;
      border: 1px solid #4a4a4a;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    .picker-title{
      font-size: 22px;
      margin: 4px 4px 12px;
      font-weight: 800;
      letter-spacing: .04em;
    }
    .svbox{
      position: relative; height: 240px; border-radius: 10px; overflow: hidden;
      border: 1px solid #3f3f40; margin-bottom: 12px;
    }
    .sv-grad{
      position:absolute; inset:0;
      background: linear-gradient(90deg,#fff,rgba(255,255,255,0));
    }
    .sv-shade{
      position:absolute; inset:0;
      background: linear-gradient(0deg,#000,rgba(0,0,0,0));
    }
    .sv-cursor{
      position:absolute; width:18px; height:18px; border-radius:50%;
      border:2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.7);
      transform: translate(-50%,-50%);
      pointer-events: none;
    }
    .hue-row{ display:flex; align-items:center; gap:10px; margin: 8px 0 10px; }
    .hue{
      flex:1; height:16px; border-radius:8px; border:1px solid #3f3f40; position:relative;
      background: linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
    }
    .hue-cursor{
      position:absolute; top:50%; width:18px; height:18px; border-radius:50%;
      border:2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.7);
      transform: translate(-50%,-50%);
      left: 0%;
    }
    .preview{
      width:100%; height:40px; border-radius:10px; border:1px solid #3f3f40;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      margin-bottom: 10px;
    }

    /* ⬇⬇ Kleiner gemachte RGB-Felder (nur diese Werte geändert) */
    .rgb-row{ display:flex; gap:6px; margin-top:8px; }
    .rgb-row label{ display:flex; flex-direction:column; gap:4px; font-size:10px; flex:1; }
    .rgb-row input{
      padding:8px 8px; font-size:16px; height:36px;
      border-radius:10px; border:1px solid #4a4a4a; background:#1c1c1d; color:#f2f2f2;
    }

    .picker-actions{
      margin-top: 12px;
      display:flex; gap:10px; justify-content:space-between;
    }
    .picker-actions button{
      flex:1; padding:9px 11px; font-size:15px;
      border-radius:12px; border:1px solid #5a5a5c; color:#e6e6e7; background:#3c3c3e;
    }
    .picker-actions button.apply{ background:#4b6ee7; border-color:#6480ff; }
  </style>
</head>
<body>

  <!-- Zahnrad -->
  <button class="gear" id="gearBtn" aria-label="Open settings">
    <img src="settings.png" alt="settings">
  </button>

  <!-- Settings Panel -->
  <section class="settings" id="settings">
    <h2>Change colors</h2>

    <div class="row"><label>Hour:</label>   <div class="swatch" id="sw_hours"></div></div>
    <div class="row"><label>Minute:</label> <div class="swatch" id="sw_minutes"></div></div>
    <div class="row"><label>Second:</label> <div class="swatch" id="sw_seconds"></div></div>
    <div class="row"><label>Year:</label>   <div class="swatch" id="sw_year"></div></div>
    <div class="row"><label>Month:</label>  <div class="swatch" id="sw_month"></div></div>
    <div class="row"><label>Day:</label>    <div class="swatch" id="sw_day"></div></div>
    <div class="row"><label>Cube edge:</label> <div class="swatch" id="sw_edge"></div></div>
    <div class="row"><label>Background:</label> <div class="swatch" id="sw_bg"></div></div>

    <button class="btn" id="btnDefaults">Default colors</button>
    <button class="btn" id="btnToggle">Time/Date (space)</button>
    <button class="btn" id="btnClose">Close</button>
  </section>

  <!-- Farbwähler -->
  <div class="picker" id="picker">
    <div class="picker-card">
      <div class="picker-title" id="pickTitle">Select color</div>
      <div class="svbox" id="svBox">
        <div class="sv-grad"></div>
        <div class="sv-shade"></div>
        <div class="sv-cursor" id="svCursor" style="left:100%; top:0%"></div>
      </div>

      <div class="hue-row">
        <div class="hue" id="hue">
          <div class="hue-cursor" id="hueCursor" style="left:0%"></div>
        </div>
      </div>

      <div class="preview" id="preview"></div>

      <div class="rgb-row">
        <label>R<input type="number" id="rIn" min="0" max="255"></label>
        <label>G<input type="number" id="gIn" min="0" max="255"></label>
        <label>B<input type="number" id="bIn" min="0" max="255"></label>
      </div>

      <div class="picker-actions">
        <button id="btnCancel">Cancel</button>
        <button class="apply" id="btnApply">Apply</button>
      </div>
    </div>
  </div>

  <!-- Würfel -->
  <div class="scene">
    <div class="cube" id="cube">
      <div class="face front"  id="year">00</div>
      <div class="face back"   id="month">00</div>
      <div class="face right"  id="seconds">00</div>
      <div class="face left"   id="minutes">00</div>
      <div class="face top"    id="hours">00</div>
      <div class="face bottom" id="day">00</div>
    </div>
  </div>

  <button id="toggleButton" onclick="toggleCube()">
    <img src="spacebar_icon.png" alt="Leertaste" />
  </button>

  <script>
    /* =========================
       KONFIG: Picker-Titelwort
       ========================= */
    const PICKER_TITLE = 'Select color'; // z.B. 'Pick color' / 'Farbe wählen'

    /* ======= Uhr & Würfel (unverändert) ======= */
    let showingDate = false;
    let rotateX = -30;
    let rotateY = 45;
    let isDragging = false;
    let lastX, lastY;
    let userRotated = false;
    let inactivityTimer;
    let toggleCount = 0;

    const cube = document.getElementById("cube");
    const toggleButton = document.getElementById("toggleButton");

    function updateTime() {
      const now = new Date();
      const monthNames = ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];
      document.getElementById("hours").textContent = String(now.getHours()).padStart(2,'0');
      document.getElementById("minutes").textContent = String(now.getMinutes()).padStart(2,'0');
      document.getElementById("seconds").textContent = String(now.getSeconds()).padStart(2,'0');
      document.getElementById("year").textContent = String(now.getFullYear() % 100).padStart(2,'0');
      document.getElementById("month").textContent = monthNames[now.getMonth()];
      document.getElementById("day").textContent = String(now.getDate()).padStart(2,'0');
    }

    function toggleCube() {
      toggleCount++;
      if (toggleCount >= 2) toggleButton.style.display = "none";
      showingDate = !showingDate;
      rotateX = showingDate ? -215 : -30;
      rotateY = 45;
      cube.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
    }

    function resetToClockView() {
      if (showingDate || userRotated) {
        showingDate = false;
        userRotated = false;
        rotateX = -30;
        rotateY = 45;
        cube.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      }
    }
    function startInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(resetToClockView, 10000);
    }

    cube.addEventListener("mousedown", (e) => {
      isDragging = true;
      lastX = e.clientX; lastY = e.clientY;
    });
    document.addEventListener("mouseup", () => { isDragging = false; });
    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      lastX = e.clientX; lastY = e.clientY;
      rotateY += dx * 0.5; rotateX -= dy * 0.5;
      cube.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      userRotated = true; startInactivityTimer();
    });

    // Touch (unverändert)
    document.body.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      lastX = t.clientX; lastY = t.clientY;
    });
    document.body.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const t = e.touches[0];
      const dx = t.clientX - lastX;
      const dy = t.clientY - lastY;
      lastX = t.clientX; lastY = t.clientY;
      rotateY += dx * 1; rotateX -= dy * 1;
      cube.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      userRotated = true; startInactivityTimer();
    }, { passive:false });

    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.target.matches('button, input, textarea')) {
        e.preventDefault(); toggleCube();
      }
    });

    setInterval(updateTime, 1000);
    updateTime();

    /* ============ Settings: State & Farben ============ */
    const namesMap = {
      hours:'Hour', minutes:'Minute', seconds:'Second',
      year:'Year', month:'Month', day:'Day',
      edge:'Cube edge', bg:'Background'
    };

    const colorVars = {
      hours:   '--c-hours',
      minutes: '--c-mins',
      seconds: '--c-secs',
      year:    '--c-year',
      month:   '--c-month',
      day:     '--c-day',
      edge:    '--c-cubeedge',
      bg:      '--c-bg'
    };

    const defaultColors = {
      hours:'#e71f1b', minutes:'#ff8c42', seconds:'#fff275',
      year:'#4B0082', month:'#2f4fba', day:'#87c8fa',
      edge:'#555555', bg:'#000000'
    };

    function applyColor(key, hex){
      document.documentElement.style.setProperty(colorVars[key], hex);
      // spezielle Ziele zusätzlich
      if (key==='edge'){
        document.querySelectorAll('.face').forEach(f=>f.style.borderColor = hex);
      }
      if (key==='bg'){
        document.body.style.background = hex;
      }
      // Swatch füllen + speichern
      document.getElementById('sw_'+key).style.background = hex;
      saveColors();
    }

    function loadColors(){
      const saved = JSON.parse(localStorage.getItem('cube_colors') || '{}');
      const cfg = Object.assign({}, defaultColors, saved);
      Object.keys(cfg).forEach(k => applyColor(k, cfg[k]));
    }
    function saveColors(){
      const obj = {};
      Object.keys(defaultColors).forEach(k=>{
        obj[k] = getComputedStyle(document.documentElement).getPropertyValue(colorVars[k]).trim() || defaultColors[k];
      });
      localStorage.setItem('cube_colors', JSON.stringify(obj));
    }

    /* ============ Settings UI Steuerung ============ */
    const gearBtn = document.getElementById('gearBtn');
    const settings = document.getElementById('settings');
    document.getElementById('btnClose').onclick = ()=> settings.classList.remove('show');
    gearBtn.onclick = ()=> settings.classList.toggle('show');
    document.getElementById('btnDefaults').onclick = ()=>{
      Object.entries(defaultColors).forEach(([k,v])=>applyColor(k,v));
    };
    document.getElementById('btnToggle').onclick = ()=> toggleCube();

    // Swatches klickbar
    ['hours','minutes','seconds','year','month','day','edge','bg'].forEach(key=>{
      document.getElementById('sw_'+key).onclick = ()=> openPicker(key);
    });

    /* ============ RGB Picker Logik ============ */
    const picker = document.getElementById('picker');
    const pickTitle = document.getElementById('pickTitle');
    const svBox = document.getElementById('svBox');
    const svCursor = document.getElementById('svCursor');
    const hue = document.getElementById('hue');
    const hueCursor = document.getElementById('hueCursor');
    const preview = document.getElementById('preview');
    const rIn = document.getElementById('rIn');
    const gIn = document.getElementById('gIn');
    const bIn = document.getElementById('bIn');
    const btnCancel = document.getElementById('btnCancel');
    const btnApply  = document.getElementById('btnApply');

    let currentKey = null;
    let H=0, S=1, V=1; // HSV intern

    function hexToRgb(hex){
      hex = hex.replace('#','');
      if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      const num = parseInt(hex,16);
      return {r:(num>>16)&255, g:(num>>8)&255, b:(num)&255};
    }
    function rgbToHex(r,g,b){
      return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
    }
    function rgbToHsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const d = max-min;
      let h=0;
      if(d!==0){
        switch(max){
          case r: h = (g-b)/d + (g<b?6:0); break;
          case g: h = (b-r)/d + 2; break;
          case b: h = (r-g)/d + 4; break;
        }
        h/=6;
      }
      const s = max===0?0:d/max;
      const v = max;
      return {h,s,v};
    }
    function hsvToRgb(h,s,v){
      let r,g,b;
      let i = Math.floor(h*6);
      let f = h*6 - i;
      let p = v*(1-s);
      let q = v*(1-f*s);
      let t = v*(1-(1-f)*s);
      switch(i%6){
        case 0: r=v,g=t,b=p; break;
        case 1: r=q,g=v,b=p; break;
        case 2: r=p,g=v,b=t; break;
        case 3: r=p,g=q,b=v; break;
        case 4: r=t,g=p,b=v; break;
        case 5: r=v,g=p,b=q; break;
      }
      return {r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)};
    }

    function setHueBackground(){
      // Basisfarbe für SV-Box (volle Sättigung/Value)
      const {r,g,b} = hsvToRgb(H,1,1);
      svBox.style.background = `rgb(${r},${g},${b})`;
    }
    function refreshPreview(){
      const {r,g,b} = hsvToRgb(H,S,V);
      preview.style.background = `rgb(${r},${g},${b})`;
      rIn.value = r; gIn.value = g; bIn.value = b;
    }

    function openPicker(key){
      currentKey = key;
      // Name + Titelwort
      pickTitle.textContent = `${namesMap[key] || 'Color'} – ${PICKER_TITLE}`;

      // aktuelle Farbe lesen
      const hex = getComputedStyle(document.documentElement).getPropertyValue(colorVars[key]).trim() || defaultColors[key];
      const {r,g,b} = hexToRgb(hex);
      const hsv = rgbToHsv(r,g,b);
      H = hsv.h; S = hsv.s; V = hsv.v;

      // UI positionieren
      setHueBackground();
      hueCursor.style.left = `${H*100}%`;
      svCursor.style.left = `${S*100}%`;
      svCursor.style.top  = `${(1-V)*100}%`;
      refreshPreview();

      picker.classList.add('show');
    }

    function closePicker(){ picker.classList.remove('show'); }

    // SV drag
    let svDragging=false;
    svBox.addEventListener('mousedown', e=>{
      svDragging=true; updateSV(e);
    });
    document.addEventListener('mouseup', ()=> svDragging=false);
    svBox.addEventListener('mousemove', e=> { if(svDragging) updateSV(e); });

    svBox.addEventListener('touchstart', e=>{
      svDragging=true; updateSV(e.touches[0]); 
    }, {passive:false});
    svBox.addEventListener('touchmove', e=>{
      if(!svDragging) return; e.preventDefault(); updateSV(e.touches[0]);
    }, {passive:false});
    document.addEventListener('touchend', ()=> svDragging=false);

    function updateSV(e){
      const rect = svBox.getBoundingClientRect();
      const x = Math.min(Math.max(0, e.clientX - rect.left), rect.width);
      const y = Math.min(Math.max(0, e.clientY - rect.top),  rect.height);
      S = x/rect.width;
      V = 1 - y/rect.height;
      svCursor.style.left = `${S*100}%`;
      svCursor.style.top  = `${(1-V)*100}%`;
      refreshPreview();
    }

    // Hue drag
    let hDragging=false;
    hue.addEventListener('mousedown', e=>{ hDragging=true; updateHue(e); });
    document.addEventListener('mouseup', ()=> hDragging=false);
    hue.addEventListener('mousemove', e=>{ if(hDragging) updateHue(e); });

    hue.addEventListener('touchstart', e=>{ hDragging=true; updateHue(e.touches[0]); }, {passive:false});
    hue.addEventListener('touchmove', e=>{
      if(!hDragging) return; e.preventDefault(); updateHue(e.touches[0]);
    }, {passive:false});
    document.addEventListener('touchend', ()=> hDragging=false);

    function updateHue(e){
      const rect = hue.getBoundingClientRect();
      const x = Math.min(Math.max(0, e.clientX - rect.left), rect.width);
      H = x/rect.width;
      hueCursor.style.left = `${H*100}%`;
      setHueBackground();
      refreshPreview();
    }

    // RGB Inputs -> Farbe
    function clamp255(n){ n = parseInt(n||0,10); return Math.max(0, Math.min(255, n)); }
    [rIn,gIn,bIn].forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const r = clamp255(rIn.value), g = clamp255(gIn.value), b = clamp255(bIn.value);
        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        // zurück nach HSV:
        const {h,s,v} = rgbToHsv(r,g,b);
        H=h; S=s; V=v;
        hueCursor.style.left = `${H*100}%`;
        setHueBackground();
        svCursor.style.left = `${S*100}%`;
        svCursor.style.top  = `${(1-V)*100}%`;
        preview.style.background = `rgb(${r},${g},${b})`;
      });
    });

    btnCancel.onclick = closePicker;
    btnApply.onclick = ()=>{
      const {r,g,b} = {r:clamp255(rIn.value), g:clamp255(gIn.value), b:clamp255(bIn.value)};
      const hex = rgbToHex(r,g,b);
      applyColor(currentKey, hex);
      closePicker();
    };

    // Init
    loadColors();
  </script>
</body>
</html>
